---
# Copy and build nginx container
- name: Include secret variables
  ansible.builtin.include_vars:
    file: ../../../vars/secrets.yml

- name: Copy file with owner and permissions
  ansible.builtin.copy:
    src: /home/alboumed/ansible-cloud-1/srcs/nginx
    dest: /home/alboumed
# roles/my_role/tasks/main.yml

- name: Create .env file from template
  template:
    src: ../../../templates/env.j2
    dest: "/home/alboumed/.env"

- name: Creates directory
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    recurse: true
  with_items:
    - /home/alboumed/data/wp_volume
    - /home/alboumed/data/phpmyadmin_volume

- name: Create Docker volume for WordPress
  community.docker.docker_volume:
    name: wp_volume
    driver: local
    driver_options:
      type: none
      o: bind
      device: /home/alboumed/data/wp_volume
    state: present

- name: Create Docker volume for phpmyadmin
  community.docker.docker_volume:
    name: phpmyadmin_volume
    driver: local
    driver_options:
      type: none
      o: bind
      device: /home/alboumed/data/phpmyadmin_volume
    state: present

- name: Create a network
  community.docker.docker_network:
    name: mynetwork

- name: Build nginx docker image
  community.docker.docker_image:
    name: nginx_image
    build:
      path: /home/alboumed/nginx/
    source: build
    state: present

- name: Run Nginx Docker container
  community.docker.docker_container:
    name: nginx
    image: nginx_image
    state: started
    restart_policy: always
    ports:
      - "443:443"
    volumes:
      - "wp_volume:/var/www/html/wordpress"
      - "phpmyadmin_volume:/var/www/html/phpmyadmin"
    networks:
      - name: mynetwork